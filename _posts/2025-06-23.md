# XDR数据结构

## xDR结构

移动互联网数据XDR 

| 公共信息	| 移动网通用信息	| 互联网通用信息	| 特定协议单请求信息/特定业务合成信息 |
|----------|---------------|---------------|----------------|
| 公共信息包含于所有场景的XDR中，指明XDR的产生接口、城市、XDR ID等信息。 | 移动网通用信息指明移动接入方式、移动网管地址、小区ID等移动网特有的信息。 |  互联网通用信息指明数据流的开始结束时间、IP地址、应用类型、协议类型、数据量等信息。 | 特定协议信息针对常见协议定义，包括HTTP、DNS、FTP、RTSP，Email，SIP，MMS，各种协议话单互斥，即同一流量只属于一种特定协议信息话单，HTTP优先级最高。对于属于上述典型协议的会话，同时填写通用业务信息和特定协议信息；此外其他会话则仅填写通用业务信息。对于TCP建链和拆链时产生的流量，应归属于该典型协议。特定业务信息针对特别关注的业务定义，是合成XDR，以一次业务请求/登陆的粒度进行填写，需要对相关的多条数据流进行合成。特定业务合成XDR重复统计单请求XDR的流量，即，如一条数据流是HTTP视频，则同时生成HTTP XDR和视频业务XDR，又如一条数据流是私有协议的即时通信，则同时生成互联网通用XDR和即时通信业务XDR。通过单请求XDR中的Refer XDR ID字段与单请求XDR互相关联并获取通用信息。|

特定源码XDR

### 特定协议单请求信息

HTTP:

对符合以下XDR分类的典型业务及协议，同时填写通用业务信息和下文定义的特定业务信息；对于不符合下文范围的数据流量，则只填写通用业务信息。未加特殊说明的协议默认按照流输出话单。

| 字段             | 第一个 XDR                     | 中间 XDR               | 最后一个 XDR                   |
|------------------|--------------------------------|------------------------|--------------------------------|
| 开始时间         | TCP 建链开始时间               | 当前事务开始时间       | 当前事务开始时间               |
| 结束时间         | 当前事务结束时间               | 当前事务结束时间       | TCP 拆链结束时间               |
| 上行流量         | TCP 握手 + 当前事务请求流量    | 当前事务请求流量       | 当前事务请求流量               |
| 下行流量         | 当前事务响应流量               | 当前事务响应流量       | 当前事务响应流量 + TCP 拆链流量 |
| 上行包数         | TCP 握手包数 + 请求包数        | 请求包数               | 请求包数                       |
| 下行包数         | 响应包数                       | 响应包数               | 响应包数 + TCP 拆链包数         |
| TCP 建链字段     | ✅ 填写                        | ❌ 不填写              | ❌ 不填写                      |
| TCP 拆链字段     | ❌ 不填写                      | ❌ 不填写              | ✅ 填写                        |

COAP

模式一：定时截断（默认 5 分钟）
| 特点	| 说明|
|---------|------|
| 粒度较粗	| 每隔一定时间（如 5 分钟）生成一条话单 |
| 只记录第一次事务的详细信息	| 包括事务类型（GET/POST）、响应码等 |
| 其余事务只统计	| 比如记录总共发起了多少次请求，总流量等 |
| 适合低频通信设备	| 如每天只上报几次的传感器 |

📌 举例：

一个 NB-IoT 设备在 5 分钟内发起了 3 次 CoAP 请求：
* 第一次：GET /temp，响应码 2.05
* 第二次：GET /temp，响应码 2.05
* 第三次：GET /temp，响应码 2.05
生成的话单：

| 字段	| 内容 |
|-------|------|
| 第一次请求类型	| GET |
| 第一次响应码	| 2.05 |
| 总请求次数	| 3 |
| 总数据量	| 300 字节 |
| 话单周期	| 5 分钟 |

✅ 模式二：按 message ID 生成话单

| 特点	| 说明|
|---------|------|
| 粒度较细	| 每个 CoAP 消息（由 message ID 标识）生成一条话单 |
| 记录每条事务的详细信息	| 包括类型、响应码、时间戳等 |
| 支持按 IP 策略配置	| 可以只对某些 IP 的设备启用这种粒度 |
| 适合高精度分析场景	| 如安全审计、异常检测 |

📌 举例：

同样 3 次 CoAP 请求（每个都有不同的 message ID），生成 3 条话单：

| 消息ID  | 请求类型 | 响应码 | 时间戳   |
|---------|----------|--------|----------|
| 0x1234  | GET      | 2.05   | 10:00:00 |
| 0x1235  | GET      | 2.05   | 10:00:10 |
| 0x1236  | GET      | 2.05   | 10:00:20 |

### 特定业务合成信息

特定业务合成XDR重复，再一次统计单请求XDR的流量，即，如一条数据流是HTTP视频，则同时生成HTTP XDR和视频业务XDR，又如一条数据流是私有协议的即时通信，则同时生成互联网通用XDR和即时通信业务XDR。

#### 即时通信业务

以用户单次登陆粒度填写，每次用户登录后产生的通信行为作为一个独立的会话进行记录。如果长时间在线，可对话单按时长进行切分，切割时长设置为N，N可配置且默认值为5分钟。对于部分场景，如发送图片或者视频，可能出现将一张图片或者视频拆分为不同的流，DPI设备需要将多流关联识别为一次图片或者视频发送。该话单需包含但不限定以下业务：微信、QQ。

| 字段名	| 编码格式 |	Tag值 |	类型	| 长度	| 默认值	| 说明 |
|-----|------|------|------|--------|-------|------|
|-----|------|------|------|--------|-------|------|

### 特定源码信息

| 公共信息	| 移动网通用信息 | 特定源码信息 |
|-----|------|------|
|-----|------|------|
